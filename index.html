<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talk to Master Yoda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #0a0a0a;
            color: #f8f8f8;
            background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=1471&auto=format&fit=crop');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }
        
        .yoda-green {
            color: #8bc34a;
        }
        
        .yoda-dark {
            background-color: #1a1a1a;
        }
        
        .chat-container {
            height: 70vh;
            background-color: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid #333;
        }
        
        .message-yoda {
            border-left: 4px solid #8bc34a;
        }
        
        .message-user {
            border-right: 4px solid #4a8bc3;
        }
        
        .lightsaber {
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #8bc34a, #4a8bc3);
            position: relative;
            box-shadow: 0 0 10px #8bc34a, 0 0 20px #8bc34a;
        }
        
        .lightsaber::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            background: #8bc34a;
            border-radius: 50%;
            right: -5px;
            top: -3px;
            box-shadow: 0 0 10px #8bc34a, 0 0 20px #8bc34a;
        }
        
        .typing-indicator {
            position: relative;
        }
        
        .typing-indicator::after {
            content: '...';
            position: absolute;
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        
        .star-wars-font {
            font-family: 'Pathway Gothic One', sans-serif;
            letter-spacing: 2px;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .yoda-avatar-flipped {
            transform: scaleX(-1);
        }
    </style>
</head>
<body>
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="yoda-dark py-6 px-4 shadow-lg">
            <div class="container mx-auto flex flex-col md:flex-row items-center justify-between">
                <div class="flex items-center mb-4 md:mb-0">
                    <img src="assets/yoda_icon.png" alt="Yoda Icon" class="h-10 w-10 mr-3">
                    <h1 class="text-2xl font-bold star-wars-font">
                        <span class="yoda-green">Talk to</span> Master Yoda
                    </h1>
                </div>
                <div class="text-sm text-gray-400">
                    <p>Wisdom from 900 years old, you seek. Answer I will.</p>
                </div>
            </div>
        </header>
        
        <!-- Lightsaber divider -->
        <div class="lightsaber"></div>
        
        <!-- Main content -->
        <main class="flex-grow container mx-auto px-4 py-8">
            <!-- Added flex container for chat and image -->
            <div class="flex flex-col md:flex-row gap-8">
                <!-- Left side: Chat -->
                <div class="w-full md:w-3/5 lg:w-2/3">
                    <div class="chat-container rounded-lg shadow-xl overflow-hidden flex flex-col h-[75vh]"> <!-- Adjusted height -->
                        <!-- Chat messages -->
                        <div id="chatMessages" class="flex-grow overflow-y-auto p-4 space-y-4">
                            <!-- Yoda's welcome message -->
                            <div class="message-yoda bg-gray-800 rounded-r-lg p-4 max-w-3xl fade-in ml-auto">
                                <div class="flex items-start flex-row-reverse">
                                    <div class="flex-shrink-0">
                                        <img src="assets/yoda_icon.png" alt="Yoda" class="w-10 h-10 rounded-full yoda-avatar-flipped">
                                    </div>
                                    <div class="mr-3">
                                        <p class="font-bold yoda-green text-right">Master Yoda</p>
                                        <p class="mt-1 text-gray-300 text-left">
                                            Welcome, young Padawan. Speak with you, I will. Ask your questions, you may.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Input area -->
                        <div class="p-4 border-t border-gray-700">
                            <form id="chatForm" class="flex">
                                <input 
                                    type="text" 
                                    id="userInput" 
                                    placeholder="Ask Yoda a question..." 
                                    class="flex-grow bg-gray-800 text-white rounded-l-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500"
                                    autocomplete="off"
                                >
                                <button 
                                    type="submit" 
                                    class="bg-green-700 hover:bg-green-600 text-white px-6 py-3 rounded-r-lg font-medium transition-colors"
                                >
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                            <p class="text-xs text-gray-500 mt-2">
                                Example: "What is the meaning of life?"
                            </p>
                        </div>
                    </div>
                </div>
                <!-- Right side: Image -->
                <div class="w-full md:w-2/5 lg:w-1/3 hidden md:flex md:items-center md:justify-center">
                     <img src="assets/yoda_char.png" alt="Master Yoda Character" class="max-w-full h-auto rounded-lg shadow-lg object-contain max-h-[75vh]"> <!-- Added image -->
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="yoda-dark py-4 px-4 text-center text-gray-400 text-sm">
            <p>This is not an official Star Wars website. Created by fans, for fans.</p>
            <p class="mt-1">May the Force be with you.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatForm = document.getElementById('chatForm');
            const userInput = document.getElementById('userInput');
            const chatMessages = document.getElementById('chatMessages');
            const backendUrl = '/ask-yoda'; // Our new backend endpoint
            
            // Add a new message to the chat
            function addMessage(sender, message, isYoda = false) {
                const messageDiv = document.createElement('div');
                // Conditionally add ml-auto for Yoda messages (swapped logic)
                const alignmentClass = isYoda ? 'ml-auto' : ''; 
                messageDiv.className = `message-${isYoda ? 'yoda' : 'user'} bg-gray-800 rounded-lg p-4 max-w-3xl ${alignmentClass} fade-in`;
                
                // Use local icon for Yoda, placeholder for User
                const iconSrc = isYoda ? 'assets/yoda_icon.png' : 'https://cdn-icons-png.flaticon.com/512/149/149071.png'; // Using placeholder for user
                const altText = isYoda ? 'Yoda' : 'You';

                // Apply flex-row-reverse for Yoda messages (swapped logic)
                messageDiv.innerHTML = `
                    <div class="flex items-start ${isYoda ? 'flex-row-reverse' : ''}">
                        <div class="flex-shrink-0">
                            <img src="${iconSrc}" 
                                 alt="${altText}" 
                                 class="w-10 h-10 rounded-full ${isYoda ? 'yoda-avatar-flipped' : ''}">
                        </div>
                        <div class="${isYoda ? 'mr-3' : 'ml-3'}">
                            <p class="font-bold ${isYoda ? 'yoda-green text-right' : 'text-blue-400'}">${isYoda ? 'Master Yoda' : 'You'}</p>
                            <p class="mt-1 text-gray-300 text-left">${message}</p>
                        </div>
                    </div>
                `;
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Show typing indicator
            function showTypingIndicator() {
                const typingDiv = document.createElement('div');
                // Added ml-auto for right alignment
                typingDiv.className = 'message-yoda bg-gray-800 rounded-r-lg p-4 max-w-3xl fade-in ml-auto'; 
                typingDiv.id = 'typingIndicator';
                
                // Apply flex-row-reverse for right alignment
                typingDiv.innerHTML = `
                    <div class="flex items-start flex-row-reverse">
                        <div class="flex-shrink-0">
                            <img src="assets/yoda_icon.png" alt="Yoda" class="w-10 h-10 rounded-full yoda-avatar-flipped">
                        </div>
                        <div class="mr-3">
                            <p class="font-bold yoda-green text-right">Master Yoda</p>
                            <p class="mt-1 text-gray-300 typing-indicator text-left">Thinking</p>
                        </div>
                    </div>
                `;
                
                chatMessages.appendChild(typingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Hide typing indicator
            function hideTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }
            
            // Function to call our backend
            async function getBackendResponse(userMessage) {
                console.log("Attempting to call backend endpoint:", backendUrl); // Updated log
                try {
                    console.log("About to call fetch to backend..."); // Updated log

                    const response = await fetch(backendUrl, { // Changed URL
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // 'Authorization': `Bearer ${apiKey}` // REMOVED Authorization header from frontend call
                        },
                        body: JSON.stringify({
                            // We only need to send the message to the backend
                            message: userMessage
                        })
                    });

                    console.log("Fetch call to backend completed, response received."); // Updated log
                    console.log("Received backend response status:", response.status); // Updated log

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Failed to parse error JSON from backend' })); // Updated error source
                        console.error('Backend Error Response Data:', errorData); // Updated log
                        throw new Error(`Backend request failed with status ${response.status}: ${errorData.error || 'Unknown backend error'}`); // Updated error source
                    }

                    const data = await response.json();
                    console.log("Received backend data:", data); // Updated log

                    // Extract the response text - backend should return it in a known format, e.g., { yodaResponse: "..." }
                    if (data.yodaResponse) {
                        console.log("Extracted response from backend:", data.yodaResponse); // Updated log
                        return data.yodaResponse;
                    } else {
                        console.error('Unexpected backend response structure:', data);
                        throw new Error('Could not parse response from backend.'); // Updated error source
                    }

                } catch (error) {
                    console.error('Error caught in getBackendResponse:', error); // Updated function name in log
                    if (error instanceof TypeError && error.message.includes('Failed to fetch')) { // Keep this check
                         console.error("This might indicate the backend server is not running or reachable.");
                    } else if (error instanceof Error && error.message.includes('Backend request failed')) { // Updated check
                         console.error("The backend server responded with an error status.");
                    } else {
                         console.error("An unexpected error occurred during the backend call process.");
                    }
                    return "Hmm, connection lost to the Force, it seems. Tell the server admin, you should."; // Updated error message
                }
            }

            // Process user input
            chatForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const message = userInput.value.trim();
                if (!message) return;
                
                // Add user message
                addMessage('user', message);
                userInput.value = '';
                
                // Show Yoda is typing
                showTypingIndicator();
                
                // Get response from Backend
                const yodaResponse = await getBackendResponse(message); // Changed function call
                
                hideTypingIndicator();
                
                // Add Yoda's response
                addMessage('yoda', yodaResponse, true);
            });
            
            // Allow pressing Enter to submit (but Shift+Enter for new line)
            userInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    chatForm.dispatchEvent(new Event('submit'));
                }
            });
        });
    </script>
</body>
</html>